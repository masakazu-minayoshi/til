# SQLインジェクション  
## SQLインジェクションとは？  
* 不正な「SQL」の命令を攻撃対象のウェブサイトに注入する（インジェクションする）のこと。  
* アプリケーションのSQLの呼び出し方においてセキュリティ上の不備を意図的に利用し、<br>データベースシステムを不正に操作する攻撃方法。  
### 想定される被害  
* データベース内のすべての情報が外部から盗まれる。  
* データベースの内容が書き換えられる。  
* IDとパスワードを用いずにログインされる(不正ログイン)。  
* データベースサーバー上のファイルの読み出し、書き込み、プログラムの実行などを行われる。  
[![Image from Gyazo](https://i.gyazo.com/1dd40916028b125a99d8f10633504369.png)](https://gyazo.com/1dd40916028b125a99d8f10633504369)

## SQLインジェクションの攻撃例・対策  
### 対策方法
[![Image from Gyazo](https://i.gyazo.com/08117a2d4457c258c2bfe44993c4f544.png)](https://gyazo.com/08117a2d4457c258c2bfe44993c4f544)
#### SQL文中で意味を持つ特殊文字をエスケープする  
* SQL文中では「'」が文字列の終端、「/」がエスケープ文字を意味する。  
(例)データベース内の格納されたuser_idとpasswordが一致したら、認証を認めるアプリケーションの場合。  
[認証に用いられるSQL文]  
```
# $uidと$pwdはユーザのフォームの入力値
SELECT * FROM user WHERE user_id='$uid' AND password='$pwd' 
```
* 下記入力をする。  
```
$uid  tarou
$pwd  ' OR 'A'='A
```
* SQL文が以下のようになる。  
```
SELECT * FROM user WHERE user_id='tarou' AND password='' OR 'A'='A'
```
* 特殊文字をきちんとエスケープした場合はユーザからの入力の「'」は単なる文字列として扱われるため、<br>```password=' ' OR 'A'='A(文字列) '```となり、SQL文は実行されない。  

#### バインド機構を利用する  
[バインド機構]  
* ユーザからの値を割り振る前に、そのままデータベースを処理するところに送られ、<br>SQL文の構造を確定する仕組みのこと。   
* SQL文確定後にユーザからの値を入れて実行するためユーザの入力値によってSQL文が変更されることはない。  
[例]  
* SQL文を処理を行う前にデータベースエンジンに送信する。  
*プレスホルダー:ユーザの値が入力されるまでの一時的な値のようなもの。(例) 「?」  
```
(例)「ユーザテーブルにおいてuser_idとpasswordの組み合わせが一致するかどうかを判定できる構文
SELECT * FROM user WHERE user_id=? AND password=?
```
上記記述をすることで、この後ユーザからどんな値が入力されようとも、<br>構文の中でSQLが実行されSQLインジェクションを防ぐことができる。  
[![Image from Gyazo](https://i.gyazo.com/2f6310a385d9033e1592c1f349358fd0.png)](https://gyazo.com/2f6310a385d9033e1592c1f349358fd0)

## RailsでのSQLインジェクション対策  
* ActiveRecordを使用する場合はRailsアプリケーションにおいてSQLインジェクションが問題になることはほとんどない。  
* しかしActiveRecordの発行するSQL文では、アプリケーションの機能として要件を満たせない場合がある。  
→この場合、直接SQL文を記述する必要がある。  
### (例)**find_by_sql**  
* SQL文を直接書いて、レコードを取得するメソッド。  
* find_by_sqlメソッドにSQLインジェクションの脆弱性が潜んでいるので、使用する際は注意が必要である。  
* 下記はusersテーブルから全てのレコードを取得する処理をfind_by_sqlメソッドを使った例。  
ActiveRecordとは異なり直接SQL文を記述する。  
```
User.find_by_sql('select * from users')
```



> 参照  
[初心者向け】SQLインジェクションの概要と対策方法](https://www.kagoya.jp/howto/network/sql-injection/)  






