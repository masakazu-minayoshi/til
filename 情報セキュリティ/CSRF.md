# CSRF  
## CSRF(クロスサイトリクエストフォージェリ)とは？  
* Webサイトにスクリプトや自動転送（HTTPリダイレクト）を仕込むことによって、<br>利用者に意図せず別のWebサイト上で何らかの操作（掲示板への書き込みや銀行口座への送金など）を行わせる攻撃手法。  
* CSRF脆弱性の影響は「重要な処理」の悪用に限られるため、CSRFの脆弱性を個人情報の取得等に用いることはできない。  
### 想定される被害    
* 利用者のアカウントによる物品の購入。  
* 利用者の退会処理。  
* 利用者のアカウントによる掲示板への書き込み。  
* 利用者のパスワードやメールアドレスが変更。  
### CSRFの攻撃例  
* 利用者が罠サイトを閲覧することによってパスワードが変更されてしまうケース   

[![Image from Gyazo](https://i.gyazo.com/baa5e681c9b3894895ec665635d28a16.png)](https://gyazo.com/baa5e681c9b3894895ec665635d28a16)

## CSRFの対策  
* CSRF攻撃を防ぐには、「重要な処理」に対するリクエストが利用者の意図によるものかどうかを確認することが必要である。  
### [対策]CSRF対策の必要なページを区別する  
* 対策に必要なページは、他のサイトから勝手に実行されては困るようなページなどが挙げられる。  
(例)ECサイトの物品購入ページやパスワード変更など個人情報の編集確定画面など。  
* まず実装するWebアプリケーションのどのページに脆弱性対策が必要なのか設計段階で明らかにする。  
そして下記のように、機能一覧の中でCSRFの対策が必要なページを色分けして見分けをつける。  
[![Image from Gyazo](https://i.gyazo.com/7b8420bd5f261ffd9306c6b102a2de3b.png)](https://gyazo.com/7b8420bd5f261ffd9306c6b102a2de3b)
### [対策]正規利用者の※意図したリクエストを区別できるように実装する  
* CSRF対策で必要なことは、正規利用者の意図したリクエストなのかどうかということ。  
※利用者が対象のアプリケーション上で「実行」ボタンなどを押して、「重要な処理」のリクエストを発行することなど。  
### 正規のリクエストかどうかを判断する方法。  
#### (1)秘密情報の埋め込み  
* 登録画面や注文確定画面などのCSRF攻撃への対策が必要なページに対して、  
第三者の不正利用者が知り得ない秘密情報を要求するようにすれば、  
不正リクエストによる重要な処理が実行されることはない。  
[![Image from Gyazo](https://i.gyazo.com/9d84a0ef028f463e7693db48483d90d9.png)](https://gyazo.com/9d84a0ef028f463e7693db48483d90d9)
#### (2)パスワードの再入力  
* CSRF対策の他にも物品の購入などに先立って利用者の意思の念押しをしたり、<br>共用のPCにおいて正規の利用者以外の利用者が、重要な処理を実行するのを防いだりする効果がある。  
* (CSRFの攻撃例)とりあげたパスワード変更ページにも現在のパスワードを再入力させることによりCSRF攻撃を防ぐことが可能。  
しかし、対策が必要なページ以外でパスワード再入力を求めるページが複数あると煩雑なアプリケーションになるので注意が必要。  
#### (3)Refererのチェック  

### RailsでのCSRF対策方法  
* Rails側できちんと対策を行っているので、基本的には開発者はなにもしなくてOK!  
```
[app/controllers/application_controller.rb]
class ApplicationController < ActionController::Base
# 省略
  #Railsアプリケーション内でCSRF対策を行うというという命令
  protect_from_forgery with: :exception
# 省略
end
```
* Rails5.2以降では、```ActionController :: Base```で、はじめからCSRF対策機能が有効になっているので、<br>application_controller.rbにこの記述がなくなる。   

## CSRF対策フロー  
(1)まずサイトのHTMLに一意のトークンを埋め込む。  
(2)これと同じトークンを、セッションcookie(クッキー)にも保存する。  
(3)ユーザーがPOSTリクエストを送信すると、HTMLに埋められているCSRFトークンも一緒に送信される。  
(4)後はサーバ側でページのトークンとセッション内のトークンを比較し、両者が一致することを確認したらリクエストを受け付ける。  








> 参考  
[CSRF（クロスサイトリクエストフォージェリ）の意味とその対策](https://www.shadan-kun.com/blog/measure/2640/)  







