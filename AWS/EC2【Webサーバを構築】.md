# EC2【Webサーバを構築】  
## EC2とは何？  
* Elastic Compute Cloudの略でAWSクラウド上の仮想サーバーのこと。<br>インスタンスというのはEC２から立てられたサーバーのこと。  
### 特徴  
* 数分で起動し1時間または秒単位の従量課金。  
* サーバーの追加・削除・マシンスペック変更も数分でできる。  
* OSよりも上のレイヤについては自由に設定できる。  
### 作成手順  
①AMI(Amazon Machine Image)の選択  
* **インスタンス起動に必要な情報が入ったOSのイメージ**。<br>**サーバーのテンプレートのようなモノ**。    
* 特徴  
・AWSやサードパーティがAMIを提供。  
・自前のカスタムAMIも作成ができる。  
・カスタムAMIから何台でもEC2インスタンスを起動することができる。  
②インスタンスタイプの選択  
* インスタンスタイプ：**サーバーのスペックを定義したモノ**。  
* 概要  
・インスタンスタイプにより、「CPU、メモリ、ストレージ、ネットワーク帯域」などが異なる。  
・インスタンスタイプにより料金が異なる。スペックが高いほど料金も高い。  
・アクセス数などに応じて必要なスペックのなるインスタンス対鵜を選択する。  
[![Image from Gyazo](https://i.gyazo.com/97e7172e580b65639442a9ada0c1342a.png)](https://gyazo.com/97e7172e580b65639442a9ada0c1342a)
③ストレージの追加  
* ストレージ：**サーバーにくっつけるデータの保存場所。**<br>EC2のストレージには２種類ある。  

|**EBS(Elastic Block Store)**|インスタンスストア|
|:--------------------------:|:------------|
|高井可用性と耐久性を持つストレージ|インスタンス専用の一時的なストレージ|
|他のインスタンスに付け替えできる|他のインスタンスに<br>付け替えることができない|
|EC2インスタンスをStop/Terminateしても<r>EBSは保存可能|EC2インスタンスを<br>Stop/Terminateするとクリアされる|
|Snapshotを取得しS3に保存ができる|追加費用なし（無料）|
|EBSの費用が別途発生|なくなってはいけないデータは置かない|
|OSやDBなどの永続性と耐久性が必要なデータを置く|一次ファイル、キャッシュなど<br>なくなっても問題がないデータを置く| 

#### EC2インスタンス作成の手順  
①ルートユーザーでログインし、EC2のサービスを選択。<br>ダッシュボード内のインスタンスを選択し、インスタンスの作成をクリック。  
②クイックスタートの「Amazon Linux 2 AMI (HVM), SSD Volume Type」を選択。<br>※AWSによってメンテナンスされており、<br>AWSの各サービスと連携できるツールやライブライが最初から入っていてすぐに使用できる。
[![Image from Gyazo](https://i.gyazo.com/ffb1fbea34c716d57f32a48c1a9bf99d.png)](https://gyazo.com/ffb1fbea34c716d57f32a48c1a9bf99d)
③インスタンスのタイプを選択。<br>特にこだわりがなければ「t2.micro」選択し、「次のステップ：インスタンスの詳細の設定」をクリック。  
[![Image from Gyazo](https://i.gyazo.com/88c15e0ea278c7e01a2af19fd4b34756.png)](https://gyazo.com/88c15e0ea278c7e01a2af19fd4b34756)
④インスタンスの詳細の設定  
必要事項を記入し「次のステップ：ストレージの追加」をクリック。  
* インスタンス数：起動するインスタンスの数。  
* ネットワーク：起動したVCPを利用した時は該当のVPCを選択。  
* 自動割り当てパブリック IP：インタネット経由でアクセスできるグローバルIPアドレスをつけるかどうかを選択する。<br>インターネットからアクセスできるようにするなら有効を選択。    
* 配置グループ：複数のEC2インスタンス間の通信を高速化する機能。  
* キャパシティーの予約  
・AWSではアベイラビリティーゾーンごとにリソースの上限が決まっている。<br>上限を超えるとEC2インスタンスが起動できなくなる。  
・キャパシティ予約すると事前に要領を確保してくれる。<br>しかし、EC2に使用の有無に関わらず料金が発生する。    
* IAMロール：EC2インスタンスが他のAWSサービスと連携する際の権限のこと。  
* インスタンスをシャットダウンした時に起動できるように、停止にするか削除するかを選択する。  
* Elastic Inference：機械学習でGPUを使用する際にコストパフォーマンスをよくする機能。  
* ネットワークインターフェイス<br>publicだけでなくprivateIPアドレスも記入できる。<br>※publicIPアドレスの範囲内で設定する。  
⑤ストレージの追加  
必要に応じて内容を変えて「次の手順：タグの追加」をクリック。  
[![Image from Gyazo](https://i.gyazo.com/91af1e1d393a5f1947d63ce52439144d.png)](https://gyazo.com/91af1e1d393a5f1947d63ce52439144d)
* ボリュームタイプ  
・ルート：OSが入っているストレージ。AMIの選択時に決まっている。    
・追加時にはEBSかインスタンスストアかを選択することができる。  
* デバイス  
・OSから見えるデバイスの名前。    
・ルートの時は最初から決まっている。EBSかインスタンスストアかを選択する時はデバイスも選択できる。  
* ルートの時は決まっていて、EBSの時は選択することができる。  
* ボリュームタイプ  
ルートかEBSの時に選択することができる。  
・汎用SSD：価格と性能のバランスがとれていてよく使われる。  
・プロビジョンド IOPS SSD：データベースなど高いio（デバイスへの入出力）が必要な時に使われる。  
・マグネティック：低いioの時でも問題がない時に使う。  
* IOPS：プロビジョンドの時だけ選択することができる。  
* スループット：１秒間のデータ転送速度。  
* 合わせて削除：課金を避ける時はチェックする。  
* 暗号化：EBSボリュームの際の暗号化。  
⑤タグの追加  
インスタンスに付与するタグを設定する。<br>必要事項を記入したら「次の手順：セキュリティグループの設定」をクリック。   
[![Image from Gyazo](https://i.gyazo.com/a7818149cab84b0aed6537c6c07e24df.png)](https://gyazo.com/a7818149cab84b0aed6537c6c07e24df)
⑥セキュリティグループの設定
インスタンスへのセキュリティを設定する。  
⑦インスタンス作成の確認。  
・記入内容を確認し起動をクリック。  
・既存のキーペアを選択するか、新しいキーペアを作成するかを選択し必要事項を記入する。  
・キーペアのダウンロードをクリック。再度、ダウンロードができないので保存する。  
## SSHとは？  
### SSHでサーバーにログインする  
* サーバーにログインするとはどういう意味？<br>→（離れた場所にある）」サーバーに入って、自分のパソコンから操作すること。  
* SSHとは？  
・**サーバーと自分の目の前のパソコンをセキュアに繋ぐサービス**のこと。  
・通信内容が暗号化された遠隔ログインシステム。  
[![Image from Gyazo](https://i.gyazo.com/f68f5ff617fac58dd2b926ad9bc44d1a.png)](https://gyazo.com/f68f5ff617fac58dd2b926ad9bc44d1a)
## 公開鍵認証とは？  
誰でもサーバーに入れるとセキュリティ上問題がある。<br>EC2ではサーバーの作成者本人だけがログインできるようにSSHログイン時に**公開鍵認証**
を行っている。  
* 公開鍵認証とは？  
・サーバへのログイン時に認証を行う仕組み。  
・ユーザー名とパスワードを使用した認証と比べ、よりセキュリティが高い。  
・公開鍵暗号（秘密鍵と公開鍵）を用いて認証を行う。  
・公開鍵はサーバーが保有。秘密鍵(pemファイル)を持っているユーザーだけがログインができる。  
[![Image from Gyazo](https://i.gyazo.com/7f7942dd3ee5650948cff9c26a7c501c.png)](https://gyazo.com/7f7942dd3ee5650948cff9c26a7c501c)
### 暗号  
他人には内容がわからないようにしてメッセージのやり取りを行うこと。  
* 公開鍵暗号は南京錠でイメージする。<br>→つまり、南京錠（公開鍵）と南京錠の鍵（秘密鍵）」のセットが必要。  
### 具体的な手順  

|ステップ|自分のコンピュータ<br>秘密鍵を保有|サーバー<br>公開鍵を保有|
|:----:|:-----------:|:-----:|
|①|ログインさせて！→||
|②||←適当なデータを公開鍵で暗号化して送るよ！|
|③|秘密鍵で復元したデータ送るよ！→||
|④||←元のデータと合っていたからログインしていいよ！|

## SSHでEC2インスタンスに接続する  
①ターミナルでpemファイルを保存したディレクトリに移動し、下記コマンドを実行。  
% chmod 600 pemファイルの名前.pem  

②EC2ダッシュボードに移動し使用するインスタンスを選択し、IPv4パブリックIPをコピー。  
※パブリックIP（インターネットから接続ができるIPアドレス）に対してSHHでログインする。  
③先ほどコピーした内容を基にターミナルに下記コマンドを打ち込む。  
%ssh -i pemファイルの名前.pem ec2-user@IPv4パブリックIPでコピーしたIPアドレス。    
こちらで指定した秘密鍵を用いてec2-userというユーザー名で「IPv4パブリックIPでコピーしたIPアドレス」に接続します。<br>という意味。  
※コマンドの説明  
* **ssh(ssh接続するためのコマンド) -i(秘密鍵に指定しているpemファイル)**<br>公開鍵認証で接続できるようにする。  
* ec2-user（サーバーにログインするためのユーザー名）  
初めて接続する時は「接続しますか？yes/no」と問い合わせが表示されるのでyesを選択する。<br>その後、接続しましたと表示される。  
[![Image from Gyazo](https://i.gyazo.com/3b7e15699e37bdb749e440df00b7eb3b.png)](https://gyazo.com/3b7e15699e37bdb749e440df00b7eb3b)
## ポート番号とは？  
### （前提）SSHでロイ運してサーバーを操作できるのは何で？  
A.サーバー上でSSH接続を受け入れ、ユーザーからのコマンドを受け付けるプログラム(sshd)が動いているから。  
Q.サーバーには起動しているプログラムが沢山ある中、<br>どのプログラムがSShのリクエストを受け付けているか、どう決めているの?  
### どのプログラムがリクエストを受け付けているのがポート番号  
* **ポート番号はプログラムのアドレス**。<br>同一コンピューター内で通信を行うプログラムを識別される時に利用される。  
[![Image from Gyazo](https://i.gyazo.com/c1ab1bd5a402f6725333b2f002d64240.png)](https://gyazo.com/c1ab1bd5a402f6725333b2f002d64240)
### ポート番号を決める方法

|標準で決められている番号|動的に決まる番号|
|:-----------------|:-----------|
|代表的なプログラムが使うポート番号は<br>あらかじめ決められている|サービスを提供する（サーバー）側は<br>ポート番号が決まっている必要がある。<br>接続元（Kuraiannto)のポート番号は<br>決まってなくてもいい|
|ウェルノウンポート番号と呼ばれる|クライアントのポート番号は、<br>OSが他のポート番号と<br>被らないようにランダムに決める|
|ウェルノウンポート番号は0~1023までの<br>いずれかの整数値をとる|動的に割り当てる番号は49142~65535までの<br>いずれかの整数値をとる|
|（例）<br>SSHは２２番<br>SMTPは２５番<br>HTTPは８０番<br>HTTPSは４４３番||
|接続元（クライアント）が<br>接続先のポート番号を省略した時は、<br>このウェルノウンポート番号が使用される||
### 作業手順  
①ターミナルでSSHにログインし「sudo lsof -i -n -P」と入力する。    
* lsof:どのポート番号でどのプログラムが待ち受けているか知るためのコマンド。  
* -i：  
・ネットワークソケットファイルを表示するためのオプション。  
・サーバーの待機ポートとプロセスを一覧にして表示する。  
* -n：IPアドレスをホスト名に変換しないオプション。  
* -P：ポート番号をサービス名に変換しないオプション。  
ターミナルで出力される単語について  
* 「LISTEN」：他のコンピュータから待ち受けているポート。 
* 「ESTABLISHED」：相手と現在通信中のポート。  
* 「*:」 ：どのIPアドレスでも接続元として受け入れる。  

## Apacheをインストールする  
①yumをアップデートするため「sudo yum update -y」とターミナルに入力する。  
* sudo：ルート権限で実行する。  
* yum：Linux（サーバーのOS）のパッケージ管理ツール。  
* -y：yesのこと。  
②「sudo yum -y install httpd」とターミナルに入力。  
* httpd：アパッチを構成する実行ファイル。  
③「sudo systemctl start httpd.service」とターミナルに入力。  
状態を確認する時は「sudo systemctl status httpd.service」と入力する。  
* 指定したコマンドを起動・再起動・停止させたるする。    
※「ps -axu」でも実行しているプロセスを確認できる。  
・ps：Linux上で実行しているプロセスを表示するコマンド。  
・axu：axが全てのプロセスを表示する、uがCPUやメモリ使用率を表示する。  
・**「/usr/sbin/httpd -DFOREGROUND」の表示があればApacheは起動している。**  
・表示内容を絞りたい時は「ps -axu | grep httpd」と入力する。  
④サーバーが起動するとApacheも自動で起動するように設定する。  
「sudo systemctl enable httpd.service」 とターミナルに入力する。<br>設定の確認は「sudo systemctl is-enabled httpd.service」と入力する。  

## ファイアウォールを設定する  
### ファイアウォールって何？  
ネットワークを不正アクセスから守るために「通してよい通信だけを通して、それ以外は通さない」機能の総称。  
### AWSにおけるファイアウォール  
AWSでは**セキュリティグループ**がファイアウォールの役割をになっている。  
[![Image from Gyazo](https://i.gyazo.com/3d34e49630be0ca2769c78f3a43ba433.png)](https://gyazo.com/3d34e49630be0ca2769c78f3a43ba433)
### 設定の手順  
①サービスのEC2ダッシュボード内のインスタンスを選択しIPv4パブリックIPをコピー。  
②説明タグ内のセキュリティグループのaws-and-infra-webをクリック。  
③インバウンドのタグをクリック  
④編集ボタンを押し、「ルールの追加」をクリックしHTTPを選択し、<br>任意の場所にタグを変更するとpublicIPアドレスのページををブラウザ上で閲覧できる。   

## Elastic IP（パブリックIPアドレスを固定するIPアドレス）  
EC2インスタンスのパブリックIPは、起動・停止すると別のIPアドレスが割り当てられる。<br>Elastic IPアドレスを使用すると、IPアドレスを固定できる。 

|Elastic IP<br>使用しない|Elastic IP<br>使用する|
|:--------------------|:--------------------|
|（停止前）<br>54.250.87.160|インターネット経由でアクセス可能な固定グローバルIPアドレスを取得できる。<br>インスタンスに付与できるサービス|
|↓**動的に変わる**|そのインスタンスを削除するまでは、ずっとそのIPアドレスを使用することができる。|
|（再起動後）<br>13.231.51.166|Elastic IPアドレスは、EC2インスタンスに関連づけられていて、<br>そのインスタンスが起動中であれば無料。そうでないと課金される。<br>Elastic IPを使用しない時はElastic IPを解放する。|

### 作業手順  
①EC2インスタンスのダッシュボードのElastic IPをクリックし「新しいアドレスの割り当て」をクリック。<br>割り当てをクリックすると新しいアドレスが割り当てられる。  
②固定するElastic IPを選択し、アクションタグのアドレスの関連付けをクリック。  
③必要事項を入力・選択肢関連付けを行う。  
[![Image from Gyazo](https://i.gyazo.com/9407ae2c2b11332866815406f2f40239.png)](https://gyazo.com/9407ae2c2b11332866815406f2f40239)
#### 費用を発生させないための手順。  
* Elastic IP  
・インスタンスを紐づけていない時は起動していない時は、<br>「アクション」→「アクションの関連付けの解除」→「アドレスの解放」を行う。  
* EC2インスタンス  
・ダッシュボード内のインスタンスを選択し、解除したいインスタンスを選択する。  
「アクション」→「インスタンスの状態」→「停止」










