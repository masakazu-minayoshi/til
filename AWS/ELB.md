# ELB
## 稼働率を上げるための基本的な考え方  
* 障害発生間隔を長くする。  
* 平均復旧時間を短くする。  
### そのための手法  
* **冗長化**（システムの構成要素を多重化すること）。    
ある構成要素で障害が発生しても処理を引き継げるようにすることで稼働率を高める。<br>→**単一障害点(SPOF)をなくす**。  
### 稼動率を上げる具体的な方法  
①要素単体の稼働率を高くする。  
②要素を組み合わせて、全体の稼働率を高くする。<br>要素を組み合わせることで、サービス構成を冗長化させる。      
[![Image from Gyazo](https://i.gyazo.com/7001a23ceeaaf04ac824038a5f253b68.png)](https://gyazo.com/7001a23ceeaaf04ac824038a5f253b68)
③負荷を適切なプロビジョニングで回避する。  
アクセス数などを予測し適切にリソースを準備する（プロビジョン）のことで、負荷を捌けるようにする。  

|スケールアップ|スケールダウン|
|:--|:--|
|サーバーなど個々の要素の性能を向上させる|サーバーなど個々の要素の数を増やす|
|ある程度の規模まではスケールアップが<br>コストパフォーマンスがよいが、一定範囲を超えると悪くなる。|ある程度の規模を超えそうであれば、<br>スケールアウトで対応する|
||最低限用意しておくべきがN＋1構成、<br>安心なのはN＋2構成|

## サーバー構成のベストプラクティス
### 基本的な構成  
* 一番最小限の構成は１台のサーバーでWebとDBを運用する。  
* パターン①：Webサーバー×①、DBサーバー×1の構成    
・１台のサーバースペック（現行構成）が足りなくなった時に、DBを別のサーバーに切り出す。  
・DBサーバーはセキュリティの観点で切り分ける。  
* パターン②：Webサーバー×2、DBサーバー×1の構成  
・Web側の性能が足りない時にウェブサーバーを複数台使うことで、<br>Webの冗長化と負荷分散を行う。  
* パターン③Webサーバー×②、DBサーバー×2の構成  
・DBをマスタースレーブ方式にすることでDBの冗長化を行う。<br>→Webの冗長化と負荷分散、DBの冗長化ができている。  
## ELBとは？  
### ロードバランサーとは？
※ロードバランサー：各サーバーにアクセスを振り分け、負荷を分散する装置。  
[![Image from Gyazo](https://i.gyazo.com/e7c9c48c49cc0af49cd738f084f41ff4.png)](https://gyazo.com/e7c9c48c49cc0af49cd738f084f41ff4)
### ELB(Elastic Load Balancing)とは何？  
* ELB：AWS上のロードバランサー  
【概要】  
* 複数のEC2インスタンスに**負荷分散**する。  
* 複数のアベイラビリティーゾーンにある複数のEC2インスタンスの中から、<br>正常なターゲットにのみ振り分ける（**ヘルスチェック**）。  
【特徴】  
* **スケーラブル**：ELB自体も負荷に応じて自動でスケールアウト、スケールインする。  
* **アベイラビリティーゾーンを跨る構成**：<br>ELBを利用する場合一つのリージョンを選び、　<br>そのリージョン内のアベイラビリティーゾーンに跨るように構成できる。  
* **名前解決**：  
・ELBにはDNS名が割り当てられる。  
・**ELBへの接続ポイントへのアクセスにはDNSを使用する**。  
* **安価な従量課金**：従量課金で利用可能。  
* **マネージドサービス**：運用が楽。  

## ELBを運用する際のポイント  
①サーバーをアベイラビリティゾーンを跨って配置する。  
②Webサーバーをステートレスに構築する。  


## ELB設定例  
[事前準備]  
* ELBの配下に接続するEC2インスタンスの事前準備とnginxも動いている状態にしておく。  
### ELBの作成を開始する  
* サービス→EC2をクリック
[![Image from Gyazo](https://i.gyazo.com/4014ab9e245699d1d88b7de6e41ccda8.png)](https://gyazo.com/4014ab9e245699d1d88b7de6e41ccda8)
### 「ロードバランサ」をクリック  
* 「ロードバランサの作成」をクリック
[![Image from Gyazo](https://i.gyazo.com/8384625477cef8a4d6e881a1505ded1c.png)](https://gyazo.com/8384625477cef8a4d6e881a1505ded1c)
### Application Load Balancerのところにある作成をクリック  
[![Image from Gyazo](https://i.gyazo.com/06fcbc030f08b2adb8629cff83a47348.png)](https://gyazo.com/06fcbc030f08b2adb8629cff83a47348)
### 必要な設定値を入力して、セキュリティ設定の構成をクリック  
* ALBの名前の入力やHTTP/HTTPSの別、対象VPCとアベイラビリティゾーンのチェックなどを行う。  
[![Image from Gyazo](https://i.gyazo.com/a98655341d06d6be44030f94dc8ce6b5.png)](https://gyazo.com/a98655341d06d6be44030f94dc8ce6b5)
「セキュリティグループの設定」をクリックしてから、<br>HTTP/HTTPSの別に合わせてセキュリティグループを設定する。  
（下記画像はHTTPのみ用のALBの場合）設定後ルーティングの設定をクリックする。
[![Image from Gyazo](https://i.gyazo.com/dd47c7f75e6ec71ff783d98a43511311.png)](https://gyazo.com/dd47c7f75e6ec71ff783d98a43511311)
### ターゲットグループの設定値を入力してから「ターゲットの登録」をクリック  
* ターゲットグループの名前を入力したり、配下のサーバの生存確認＝ヘルスチェックで利用するパス等を入力  
[![Image from Gyazo](https://i.gyazo.com/4234eb05d685e98110e394eedc028bb7.png)](https://gyazo.com/4234eb05d685e98110e394eedc028bb7)
### 配下に組み入れるEC2インスタンス選択してから「登録済みに追加」をクリック  
* 追加できたら「次の手順：確認」をクリック
[![Image from Gyazo](https://i.gyazo.com/451f55ef9fd9b91ab5d53286e36ead36.png)](https://gyazo.com/451f55ef9fd9b91ab5d53286e36ead36)
### 設定内容を確認して問題なければ「作成」をクリック
[![Image from Gyazo](https://i.gyazo.com/014a2f34b5c70e0e923d8c56ef6c035e.png)](https://gyazo.com/014a2f34b5c70e0e923d8c56ef6c035e)
### 作成が完了したら「閉じる」をクリックする
[![Image from Gyazo](https://i.gyazo.com/26e67173d14d31c83075a67116676f1c.png)](https://gyazo.com/26e67173d14d31c83075a67116676f1c)
### サービス→EC2→ターゲットグループ→ターゲットを開き、状態がhealthyになってことを確認
[![Image from Gyazo](https://i.gyazo.com/a9576967d2fd587e995f8c495e4a0ab4.png)](https://gyazo.com/a9576967d2fd587e995f8c495e4a0ab4)
### 説明→DNS名でアクセスできるかを確認する
[![Image from Gyazo](https://i.gyazo.com/953145cc3f395c6e7ebb140641797d62.png)](https://gyazo.com/953145cc3f395c6e7ebb140641797d62)






